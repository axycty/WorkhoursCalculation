<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æœ¬å‘¨å·¥ä½œæ—¶é•¿è®°å½•å™¨</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: auto; }
        h1 { font-size: 1.5rem; margin-bottom: 1rem; }
        button { margin: 0.5rem 0.5rem 0.5rem 0; padding: 0.5rem 1rem; font-size: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
        .summary { margin-top: 1rem; padding: 1rem; border: 1px solid #ccc; background: #f8f8f8; }
        .time-input { width: 4rem; }
        .delete-btn { color: red; cursor: pointer; }
        .editable { background-color: #eef; cursor: pointer; }
        input.inline-edit { width: 4rem; }
    </style>
</head>
<body>
<h1>ğŸ•’ æœ¬å‘¨å·¥ä½œæ—¶é•¿è®°å½•å™¨</h1>

<div class="summary">
    <div>ğŸ¯ æœ¬å‘¨ç›®æ ‡ï¼š<strong>50 å°æ—¶</strong></div>
    <div>âœ… å·²å®Œæˆï¼š<strong id="total-time">0 å°æ—¶</strong></div>
    <div>â³ è¿˜éœ€ï¼š<strong id="remaining-time">50 å°æ—¶</strong></div>
    <div>ğŸ“ é¢„è®¡å‘¨äº”å¯åœ¨ <strong id="predicted-off">--:--</strong> ä¸‹ç­</div>
</div>

<div>
    <button onclick="startWork()">ğŸŸ¢ å¼€å§‹å·¥ä½œ</button>
    <button onclick="endWork()">ğŸ”´ ç»“æŸå·¥ä½œ</button>
</div>

<h2>ğŸ“… æ‰“å¡è®°å½•ï¼ˆç‚¹å‡»ä¿®æ”¹æ—¶é—´ï¼‰</h2>
<table>
    <thead>
    <tr>
        <th>æ—¥æœŸ</th>
        <th>ä¸Šç­</th>
        <th>ä¸‹ç­</th>
        <th>æ—¶é•¿</th>
        <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody id="record-table"></tbody>
</table>

<h2>ğŸ•‘ æ—¶åˆ†å·®è®¡ç®—å™¨</h2>
<div>
    å¼€å§‹æ—¶é—´ï¼š<input type="time" id="diff-start" />ã€€
    ç»“æŸæ—¶é—´ï¼š<input type="time" id="diff-end" />
    <button onclick="calculateDiff()">è®¡ç®—å·®å€¼</button>
</div>
<div>æ—¶é—´å·®ï¼š<span id="diff-result">0 å°æ—¶ 0 åˆ†é’Ÿ</span></div>

<script>
    const WEEK_TARGET_MINUTES = 50 * 60; // 50å°æ—¶æ¢ç®—æˆåˆ†é’Ÿ
    const workData = JSON.parse(localStorage.getItem('workData') || '{}');

    // ä¿å­˜æ•°æ®å¹¶åˆ·æ–°é¡µé¢
    function saveData() {
        localStorage.setItem('workData', JSON.stringify(workData));
        renderTable();
    }

    // æ ¼å¼åŒ–åˆ†é’Ÿæ•°ä¸º â€œXå°æ—¶ Yåˆ†é’Ÿâ€
    function formatDuration(totalMinutes) {
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        return `${h} å°æ—¶${m > 0 ? ' ' + m + ' åˆ†é’Ÿ' : ''}`;
    }

    // è®¡ç®—ä¸¤ä¸ª ISO æ—¶é—´å­—ç¬¦ä¸²çš„åˆ†é’Ÿå·®
    function calcDurationMinutes(startISO, endISO) {
        const diffMs = new Date(endISO) - new Date(startISO);
        return Math.max(Math.round(diffMs / 60000), 0);
    }

    // è·å–æœ¬å‘¨å‘¨ä¸€åˆ°å‘¨äº”æ—¥æœŸå­—ç¬¦ä¸²æ•°ç»„ï¼ˆæ ¼å¼ YYYY-MM-DDï¼‰
    function getWeekDates() {
        const monday = new Date();
        const day = monday.getDay() || 7;
        if(day !== 1) monday.setDate(monday.getDate() - day + 1);
        const dates = [];
        for(let i=0; i<5; i++) {
            const d = new Date(monday);
            d.setDate(monday.getDate() + i);
            dates.push(d.toISOString().slice(0,10));
        }
        return dates;
    }

    // è¿”å›å‘¨å‡ æ ‡ç­¾
    function getDayLabel(index) {
        return ['(å‘¨ä¸€)','(å‘¨äºŒ)','(å‘¨ä¸‰)','(å‘¨å››)','(å‘¨äº”)'][index] || '';
    }

    // ç‚¹å‡»â€œå¼€å§‹å·¥ä½œâ€æŒ‰é’®ï¼Œè®°å½•å½“å‰æ—¶é—´ä¸ºä¸Šç­æ—¶é—´
    function startWork() {
        const now = new Date();
        const key = now.toISOString().slice(0,10);
        workData[key] = workData[key] || {};
        workData[key].start = now.toISOString();
        saveData();
    }

    // ç‚¹å‡»â€œç»“æŸå·¥ä½œâ€æŒ‰é’®ï¼Œè®°å½•å½“å‰æ—¶é—´ä¸ºä¸‹ç­æ—¶é—´
    function endWork() {
        const now = new Date();
        const key = now.toISOString().slice(0,10);
        if(!workData[key] || !workData[key].start) {
            alert('è¯·å…ˆæ‰“ä¸Šç­å¡');
            return;
        }
        workData[key].end = now.toISOString();
        saveData();
    }

    // åˆ é™¤æŸä¸€å¤©æ•°æ®
    function deleteRecord(date) {
        if(confirm(`ç¡®è®¤åˆ é™¤ ${date} çš„è®°å½•ï¼Ÿ`)) {
            delete workData[date];
            saveData();
        }
    }

    // ç‚¹å‡»æ—¶é—´å•å…ƒæ ¼æ—¶ï¼Œæ›¿æ¢æˆinputè®©ç”¨æˆ·ç¼–è¾‘ï¼Œç¼–è¾‘å¤±ç„¦ä¿å­˜
    function editTime(date, type, event) {
        const td = event.target;
        const currentVal = td.innerText === 'ç‚¹å‡»å¡«å†™' ? '' : td.innerText;
        td.innerHTML = `<input class="inline-edit" type="time" value="${currentVal}" />`;
        const input = td.querySelector('input');
        input.focus();
        // ç›‘å¬å¤±ç„¦å’Œå›è½¦ä¿å­˜
        function saveHandler() {
            saveTime(date, type, input.value);
        }
        input.addEventListener('blur', saveHandler);
        input.addEventListener('keydown', e => {
            if(e.key === 'Enter') {
                input.blur();
            } else if(e.key === 'Escape') {
                renderTable(); // æ”¾å¼ƒä¿®æ”¹ï¼Œæ¢å¤æ˜¾ç¤º
            }
        });
    }

    // ä¿å­˜ç¼–è¾‘æ—¶é—´å¹¶åˆ·æ–°
    function saveTime(date, type, value) {
        if(!value) {
            renderTable();
            return;
        }
        // æ‹¼æ¥æˆå®Œæ•´ISOæ—¶é—´å­—ç¬¦ä¸²
        const isoStr = `${date}T${value}:00`;
        workData[date] = workData[date] || {};
        workData[date][type] = new Date(isoStr).toISOString();
        saveData();
    }

    // æ¸²æŸ“æ‰“å¡è®°å½•è¡¨æ ¼å’Œç»Ÿè®¡æ•°æ®
    function renderTable() {
        const tbody = document.getElementById('record-table');
        tbody.innerHTML = '';
        const dates = getWeekDates();
        let totalMinutes = 0;

        dates.forEach((date, i) => {
            const record = workData[date] || {};
            let startStr = record.start ? new Date(record.start).toTimeString().slice(0,5) : '';
            let endStr = record.end ? new Date(record.end).toTimeString().slice(0,5) : '';
            let durStr = '';
            let durMin = 0;

            if(record.start && record.end) {
                durMin = calcDurationMinutes(record.start, record.end);
                durStr = formatDuration(durMin);
                totalMinutes += durMin;
            }

            tbody.innerHTML += `
          <tr>
            <td>${date} ${getDayLabel(i)}</td>
            <td class="editable" onclick="editTime('${date}', 'start', event)">${startStr || 'ç‚¹å‡»å¡«å†™'}</td>
            <td class="editable" onclick="editTime('${date}', 'end', event)">${endStr || 'ç‚¹å‡»å¡«å†™'}</td>
            <td>${durStr}</td>
            <td><span class="delete-btn" onclick="deleteRecord('${date}')">åˆ é™¤</span></td>
          </tr>
        `;
        });

        const remainMin = Math.max(WEEK_TARGET_MINUTES - totalMinutes, 0);
        document.getElementById('total-time').innerText = formatDuration(totalMinutes);
        document.getElementById('remaining-time').innerText = remainMin > 0 ? formatDuration(remainMin) : 'å·²è¾¾æˆ';

        // é¢„è®¡å‘¨äº”ä¸‹ç­æ—¶é—´
        const friday = dates[4];
        const fridayRecord = workData[friday] || {};
        if(!fridayRecord.start) {
            document.getElementById('predicted-off').innerText = '--:--ï¼ˆè¯·å…ˆå¡«å†™å‘¨äº”ä¸Šç­æ—¶é—´ï¼‰';
        } else {
            const startFri = new Date(fridayRecord.start);
            const predictedOff = new Date(startFri.getTime() + remainMin * 60 * 1000);
            const hh = predictedOff.getHours().toString().padStart(2, '0');
            const mm = predictedOff.getMinutes().toString().padStart(2, '0');
            document.getElementById('predicted-off').innerText = `${hh}:${mm}`;
        }
    }

    // æ—¶åˆ†å·®è®¡ç®—å™¨
    function calculateDiff() {
        const startVal = document.getElementById('diff-start').value;
        const endVal = document.getElementById('diff-end').value;
        if (!startVal || !endVal) {
            alert('è¯·å¡«å†™å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´');
            return;
        }
        const [sh, sm] = startVal.split(':').map(Number);
        const [eh, em] = endVal.split(':').map(Number);
        let startTotal = sh * 60 + sm;
        let endTotal = eh * 60 + em;
        // å¦‚æœç»“æŸæ—¶é—´å°äºå¼€å§‹æ—¶é—´ï¼Œé»˜è®¤ç¬¬äºŒå¤©
        if (endTotal < startTotal) endTotal += 24 * 60;
        const diff = endTotal - startTotal;
        document.getElementById('diff-result').innerText = formatDuration(diff);
    }

    renderTable(); // åˆå§‹åŒ–é¡µé¢æ¸²æŸ“
</script>
</body>
</html>
